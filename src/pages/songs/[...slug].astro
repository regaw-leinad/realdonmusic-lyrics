---
import { getCollection, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import StreamingLinks from "../../components/StreamingLinks.astro";
import ShareButtons from "../../components/ShareButtons.astro";
import DiscordCTA from "../../components/DiscordCTA.astro";

export async function getStaticPaths() {
  const songs = await getCollection("songs");
  return songs.map((song) => ({
    params: { slug: song.id },
    props: { song },
  }));
}

const { song } = Astro.props;
const { Content } = await render(song);

const pageTitle = `${song.data.title} Lyrics`;
const description =
  song.data.description ??
  `Lyrics for ${song.data.title} by Real Don Music.${song.data.album ? ` From ${song.data.album}.` : ""}`;
const pageUrl = Astro.url.href.replace(/\/$/, "");
---

<BaseLayout title={pageTitle} description={description} ogImage={`/og/${song.id}.png`}>
  <main class="mx-auto max-w-[720px] px-6 pb-20">
    <!-- Song Header -->
    <div class="flex flex-col gap-5 pb-10 pt-12 sm:flex-row sm:gap-7">
      {
        song.data.coverArt ? (
          <img
            src={song.data.coverArt}
            alt={`${song.data.title} cover art`}
            class="h-[120px] w-[120px] shrink-0 rounded-lg object-cover sm:h-[140px] sm:w-[140px]"
          />
        ) : (
          <div class="flex h-[120px] w-[120px] shrink-0 items-center justify-center rounded-lg border border-border bg-gradient-to-br from-bg-elevated via-[#1a1508] to-bg-elevated text-5xl text-gold sm:h-[140px] sm:w-[140px]">
            &#9835;
          </div>
        )
      }
      <div class="flex-1">
        {
          song.data.album && (
            <div class="mb-2 text-[13px] font-semibold uppercase tracking-[0.05em] text-gold">
              {song.data.album}
            </div>
          )
        }
        <h1
          class="mb-2 font-['Cormorant_Garamond',Georgia,serif] text-[36px] font-semibold leading-tight text-text-primary sm:text-[42px]"
        >
          {song.data.title}
        </h1>
        <div class="mb-4 flex flex-wrap items-center gap-x-2 gap-y-1 text-sm text-text-muted">
          {song.data.releaseDate && <span>{song.data.releaseDate}</span>}
          {song.data.releaseDate && song.data.duration && <span class="text-text-muted/50">&middot;</span>}
          {song.data.duration && <span>{song.data.duration}</span>}
          {(song.data.releaseDate || song.data.duration) && song.data.writers && <span class="text-text-muted/50">&middot;</span>}
          {
            song.data.writers && (
              <span>Written by {song.data.writers.join(", ")}</span>
            )
          }
        </div>
        <StreamingLinks
          spotifyUrl={song.data.spotifyUrl}
          appleMusicUrl={song.data.appleMusicUrl}
          youtubeMusicUrl={song.data.youtubeMusicUrl}
          bandcampUrl={song.data.bandcampUrl}
        />
      </div>
    </div>

    <hr class="border-border" />

    <!-- Lyrics -->
    <div class="py-10">
      <div
        class="text-[12px] font-semibold uppercase tracking-[0.08em] text-text-muted mb-6"
      >
        Lyrics
      </div>
      <div
        class="lyrics-content font-['Cormorant_Garamond',Georgia,serif] text-[22px] leading-[1.75] text-text-primary"
      >
        <Content />
      </div>
    </div>

    <hr class="border-border" />

    <!-- Share -->
    <div class="py-10">
      <ShareButtons url={pageUrl} title={song.data.title} slug={song.id} />
    </div>

    <hr class="border-border" />

    <!-- Discord CTA -->
    <div class="pt-10">
      <DiscordCTA />
    </div>
  </main>
</BaseLayout>

<style>
  .lyrics-content :global(p) {
    margin-bottom: 0.25em;
  }

  .lyrics-content :global(p:empty),
  .lyrics-content :global(p:has(br:only-child)) {
    margin-bottom: 1.25em;
  }
</style>
