---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import SongCard from "../components/SongCard.astro";

const songs = await getCollection("songs");

// Identify real albums (more than one song) vs singles
const albumCounts = new Map<string, number>();
for (const song of songs) {
  const album = song.data.album ?? "";
  albumCounts.set(album, (albumCounts.get(album) ?? 0) + 1);
}

// Parse a release date string like "December 7, 2025" into a Date
function parseDate(dateStr?: string): Date {
  if (!dateStr) return new Date(0);
  return new Date(dateStr);
}

// A "real album" has more than one song
const realAlbumNames = [...albumCounts.entries()]
  .filter(([name, count]) => name !== "" && count > 1)
  .map(([name]) => name);

// Group songs by album, track latest release date per group
type Song = (typeof songs)[number];
const albumGroups: { name: string; songs: Song[]; latestDate: Date }[] = [];

for (const albumName of realAlbumNames) {
  const albumSongs = songs
    .filter((s) => s.data.album === albumName)
    .sort((a, b) => (a.data.track ?? 99) - (b.data.track ?? 99));
  const latestDate = albumSongs.reduce(
    (max, s) => {
      const d = parseDate(s.data.releaseDate);
      return d > max ? d : max;
    },
    new Date(0),
  );
  albumGroups.push({ name: albumName, songs: albumSongs, latestDate });
}

// Singles: songs with no album, or whose "album" only has one song (self-titled singles)
const singles = songs
  .filter((s) => {
    const album = s.data.album ?? "";
    return album === "" || (albumCounts.get(album) ?? 0) <= 1;
  })
  .sort((a, b) => parseDate(b.data.releaseDate).getTime() - parseDate(a.data.releaseDate).getTime());

// Sort albums by latest release date, descending (newest first)
albumGroups.sort((a, b) => b.latestDate.getTime() - a.latestDate.getTime());

// Singles always go last
if (singles.length > 0) {
  albumGroups.push({ name: "Singles", songs: singles, latestDate: new Date(0) });
}

// Short display names for long album titles
const displayNames: Record<string, string> = {
  "Pet Care: or The Righteous One Takes Care of Their Animal": "Pet Care",
};
function shortName(name: string): string {
  return displayNames[name] ?? name;
}

// Filter labels follow the same order
const filterLabels = albumGroups.map((g) => g.name);
---

<BaseLayout title="Lyrics" description="Every word, every story. Read the lyrics for every Real Don Music song." ogImage="/images/covers/pet-care-or-the-righteous-one-takes-care-of-their-animal.jpg">
  <!-- Album filter -->
  <div class="mx-auto max-w-[960px] px-6 pt-12 pb-10" id="filters">
    <div class="mb-4 text-[13px] font-medium text-text-muted">Browse lyrics</div>
    <div class="-mx-6 flex gap-2 overflow-x-auto px-6 sm:mx-0 sm:flex-wrap sm:overflow-visible sm:px-0">
    <button
      class="filter-btn shrink-0 rounded-full border border-gold/40 bg-gold-dim px-4 py-2 text-[13px] font-medium text-gold transition-all"
      data-album="all"
    >
      All
    </button>
    {
      filterLabels.map((label) => (
        <button
          class="filter-btn shrink-0 rounded-full border border-border bg-transparent px-4 py-2 text-[13px] font-medium text-text-muted transition-all hover:border-gold/30 hover:text-text-secondary"
          data-album={label}
        >
          {shortName(label)}
        </button>
      ))
    }
    </div>
  </div>

  <!-- Album sections -->
  <div class="mx-auto max-w-[960px] px-6 pb-20" id="album-sections">
    {
      albumGroups.map((group) => (
        <section class="album-section mb-14" data-album={group.name}>
          <h2 class="mb-6 text-[24px] font-semibold tracking-tight text-text-primary sm:text-[28px]">
            {shortName(group.name)}
          </h2>
          <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
            {group.songs.map((song) => (
              <SongCard
                title={song.data.title}
                album={undefined}
                slug={song.id}
                coverArt={song.data.coverArt}
              />
            ))}
          </div>
        </section>
      ))
    }
  </div>
</BaseLayout>

<script>
  const buttons = document.querySelectorAll(".filter-btn");
  const sections = document.querySelectorAll(".album-section");

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      // Reset all buttons
      buttons.forEach((b) => {
        b.className =
          "filter-btn shrink-0 rounded-full border border-border bg-transparent px-4 py-2 text-[13px] font-medium text-text-muted transition-all hover:border-gold/30 hover:text-text-secondary";
      });
      // Activate clicked button
      btn.className =
        "filter-btn shrink-0 rounded-full border border-gold/40 bg-gold-dim px-4 py-2 text-[13px] font-medium text-gold transition-all";

      const album = btn.getAttribute("data-album");
      sections.forEach((section) => {
        if (
          album === "all" ||
          section.getAttribute("data-album") === album
        ) {
          (section as HTMLElement).style.display = "";
        } else {
          (section as HTMLElement).style.display = "none";
        }
      });
    });
  });
</script>
